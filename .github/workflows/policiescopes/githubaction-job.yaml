  validate-api-artifacts:
    name: Validate API Preconditions
    runs-on: ubuntu-latest
    needs:
      - determine_apis
    env:
      DEPLOY_APIS: ${{ needs.determine_apis.outputs.apis-to-deploy }}
    steps:

      - uses: actions/checkout@v4
        with:
          repository: sampathbankplc/middleware-apim-sampathvishwa-app-apis
          fetch-depth: 5
          path: repo

      - name: Install yq
        run: |
          sudo wget https://github.com/mikefarah/yq/releases/download/v4.35.2/yq_linux_amd64 -O /usr/bin/yq
          sudo chmod +x /usr/bin/yq

      - name: Validate API ZIPs
        id: validate_apis
        working-directory: repo
        run: |
          echo "Analyzing APIs: $DEPLOY_APIS"
          mkdir -p extracted
          
          VALIDATION_ERRORS=0
          
          echo "-------------------------------------------------------"
          echo "üìå Fetching data from APIM"
          echo "-------------------------------------------------------"
          
          APIM_ROLES=$(apictl get roles -e Dev -k | awk '{print $1}' | tail -n +3)
          APIM_POLICIES=$(apictl get policies -e Dev -k | awk '{print $1}' | tail -n +3)
          APIM_LABELS=$(apictl get gateways -e Dev -k | awk '{print $1}' | tail -n +3)
          APIM_CATEGORIES=$(apictl get api-categories -e Dev -k | awk '{print $1}' | tail -n +3)
          
          echo "APIM ‚Üí Roles:"
          echo "$APIM_ROLES"
          echo
          echo "APIM ‚Üí Policies:"
          echo "$APIM_POLICIES"
          echo
          echo "APIM ‚Üí Gateway Labels:"
          echo "$APIM_LABELS"
          echo
          echo "APIM ‚Üí API Categories:"
          echo "$APIM_CATEGORIES"
          echo "-------------------------------------------------------"
          
          
          for api in $DEPLOY_APIS; do
            echo
            echo "======================================================="
            echo "üîç Validating ZIP: $api"
            echo "======================================================="
          
            unzip -o "apim/$api" -d "extracted/$api" >/dev/null
          
            # Detect inner folder containing api.yaml
            INNER_DIR=$(find "extracted/$api" -type f -name "api.yaml" -printf '%h')
            API_YAML="$INNER_DIR/api.yaml"
          
            if [[ ! -f "$API_YAML" ]]; then
              echo "‚ùå api.yaml missing inside zip: $api"
              VALIDATION_ERRORS=$((VALIDATION_ERRORS+1))
              continue
            fi
          
            echo "üìÑ Found api.yaml at: $API_YAML"
            echo
          
            echo "-------------------------------------------------------"
            echo "üìå API ZIP ‚Üí Extracting Info"
            echo "-------------------------------------------------------"
          
            # 1Ô∏è‚É£ Roles from scopes
            ZIP_ROLES=$(yq e '.scopes[].roles // ""' "$API_YAML" | tr ',' '\n' | xargs -I {} echo {} | sort -u)
            echo "ZIP ‚Üí Roles:"
            echo "${ZIP_ROLES:-None}"
            echo
          
            # 2Ô∏è‚É£ Policies
            ZIP_POLICIES=$(yq e '.throttlingPolicy, .subscriptionPolicies[], .applicationPolicies[]?' "$API_YAML" | grep -v null || true)
            echo "ZIP ‚Üí Policies:"
            echo "${ZIP_POLICIES:-None}"
            echo
          
            # 3Ô∏è‚É£ Gateway Labels
            ZIP_LABELS=$(yq e '.gatewayLabels[]?' "$API_YAML" || true)
            echo "ZIP ‚Üí Gateway Labels:"
            echo "${ZIP_LABELS:-None}"
            echo
          
            # 4Ô∏è‚É£ API Categories
            ZIP_CATEGORIES=$(yq e '.categories[]?' "$API_YAML" || true)
            echo "ZIP ‚Üí API Categories:"
            echo "${ZIP_CATEGORIES:-None}"
            echo
          
            # 5Ô∏è‚É£ Extract endpoints
            ZIP_ENDPOINTS=$(yq e '.endpointConfig.*.url?' "$API_YAML" || true)
            echo "ZIP ‚Üí Endpoints:"
            echo "${ZIP_ENDPOINTS:-None}"
            echo
          
            echo "-------------------------------------------------------"
            echo "üìå Comparing: ZIP vs APIM"
            echo "-------------------------------------------------------"
          
            # Compare roles
            for ROLE in $ZIP_ROLES; do
              if ! echo "$APIM_ROLES" | grep -qw "$ROLE"; then
                echo "‚ö†Ô∏è Missing Role in APIM: $ROLE"
              else
                echo "‚úî Role exists: $ROLE"
              fi
            done
            echo
          
            # Compare policies
            for P in $ZIP_POLICIES; do
              if ! echo "$APIM_POLICIES" | grep -qw "$P"; then
                echo "‚ö†Ô∏è Missing Policy in APIM: $P"
              else
                echo "‚úî Policy exists: $P"
              fi
            done
            echo
          
            # Compare labels
            for L in $ZIP_LABELS; do
              if ! echo "$APIM_LABELS" | grep -qw "$L"; then
                echo "‚ö†Ô∏è Missing Gateway Label in APIM: $L"
              else
                echo "‚úî Gateway Label exists: $L"
              fi
            done
            echo
          
            # Compare categories
            for C in $ZIP_CATEGORIES; do
              if ! echo "$APIM_CATEGORIES" | grep -qw "$C"; then
                echo "‚ö†Ô∏è Missing API Category in APIM: $C"
              else
                echo "‚úî API Category exists: $C"
              fi
            done
            echo
          
            # Check Endpoint Certificates
            for E in $ZIP_ENDPOINTS; do
              HOST=$(echo "$E" | sed -E 's@https?://([^:/]+).*@\1@')
              if keytool -printcert -rfc -sslserver "$HOST" >/dev/null 2>&1; then
                echo "‚úî Endpoint cert valid: $HOST"
              else
                echo "‚ö†Ô∏è Endpoint cert NOT trusted: $HOST"
              fi
            done
          
          done
          
          echo "VALIDATION_ERRORS=$VALIDATION_ERRORS" >> $GITHUB_OUTPUT


======================================


# Find inner folder (example: ***-1.0.0)
INNER_DIR=$(find "extracted/$api" -maxdepth 1 -type d ! -path "extracted/$api")

API_YAML="$INNER_DIR/api.yaml"

if [[ ! -f "$API_YAML" ]]; then
  echo "‚ùå api.yaml missing inside zip: $api"
  echo "Checked path: $API_YAML"
  VALIDATION_ERRORS=$((VALIDATION_ERRORS+1))
  continue
fi
