  validate-api-artifacts:
    name: Validate API Preconditions
    runs-on: ubuntu-latest
    needs:
      - determine_apis
    env:
      DEPLOY_APIS: ${{ needs.determine_apis.outputs.apis-to-deploy }}
    steps:

      - uses: actions/checkout@v4
        with:
          repository: sampathbankplc/middleware-apim-sampathvishwa-app-apis
          fetch-depth: 5
          path: repo

      - name: Install yq
        run: |
          sudo wget https://github.com/mikefarah/yq/releases/download/v4.35.2/yq_linux_amd64 -O /usr/bin/yq
          sudo chmod +x /usr/bin/yq

      - name: Validate API ZIPs
        id: validate_apis
        working-directory: repo
        run: |
          echo "Analyzing APIs: $DEPLOY_APIS"
          mkdir -p extracted
          
          VALIDATION_ERRORS=0
          
          echo "-------------------------------------------------------"
          echo "ðŸ“Œ Fetching data from APIM"
          echo "-------------------------------------------------------"
          
          APIM_ROLES=$(apictl get roles -e Dev -k | awk '{print $1}' | tail -n +3)
          APIM_POLICIES=$(apictl get policies -e Dev -k | awk '{print $1}' | tail -n +3)
          APIM_LABELS=$(apictl get gateways -e Dev -k | awk '{print $1}' | tail -n +3)
          APIM_CATEGORIES=$(apictl get api-categories -e Dev -k | awk '{print $1}' | tail -n +3)
          
          echo "APIM â†’ Roles:"
          echo "$APIM_ROLES"
          echo
          echo "APIM â†’ Policies:"
          echo "$APIM_POLICIES"
          echo
          echo "APIM â†’ Gateway Labels:"
          echo "$APIM_LABELS"
          echo
          echo "APIM â†’ API Categories:"
          echo "$APIM_CATEGORIES"
          echo "-------------------------------------------------------"
          
          
          for api in $DEPLOY_APIS; do
            echo
            echo "======================================================="
            echo "ðŸ” Validating ZIP: $api"
            echo "======================================================="
          
            unzip -o "apim/$api" -d "extracted/$api" >/dev/null
          
            # Detect inner folder containing api.yaml
            INNER_DIR=$(find "extracted/$api" -type f -name "api.yaml" -printf '%h')
            API_YAML="$INNER_DIR/api.yaml"
          
            if [[ ! -f "$API_YAML" ]]; then
              echo "âŒ api.yaml missing inside zip: $api"
              VALIDATION_ERRORS=$((VALIDATION_ERRORS+1))
              continue
            fi
          
            echo "ðŸ“„ Found api.yaml at: $API_YAML"
            echo
          
            echo "-------------------------------------------------------"
            echo "ðŸ“Œ API ZIP â†’ Extracting Info"
            echo "-------------------------------------------------------"
          
            # 1ï¸âƒ£ Roles from scopes
            ZIP_ROLES=$(yq e '.scopes[].roles // ""' "$API_YAML" | tr ',' '\n' | xargs -I {} echo {} | sort -u)
            echo "ZIP â†’ Roles:"
            echo "${ZIP_ROLES:-None}"
            echo
          
            # 2ï¸âƒ£ Policies
            ZIP_POLICIES=$(yq e '.throttlingPolicy, .subscriptionPolicies[], .applicationPolicies[]?' "$API_YAML" | grep -v null || true)
            echo "ZIP â†’ Policies:"
            echo "${ZIP_POLICIES:-None}"
            echo
          
            # 3ï¸âƒ£ Gateway Labels
            ZIP_LABELS=$(yq e '.gatewayLabels[]?' "$API_YAML" || true)
            echo "ZIP â†’ Gateway Labels:"
            echo "${ZIP_LABELS:-None}"
            echo
          
            # 4ï¸âƒ£ API Categories
            ZIP_CATEGORIES=$(yq e '.categories[]?' "$API_YAML" || true)
            echo "ZIP â†’ API Categories:"
            echo "${ZIP_CATEGORIES:-None}"
            echo
          
            # 5ï¸âƒ£ Extract endpoints
            ZIP_ENDPOINTS=$(yq e '.endpointConfig.*.url?' "$API_YAML" || true)
            echo "ZIP â†’ Endpoints:"
            echo "${ZIP_ENDPOINTS:-None}"
            echo
          
            echo "-------------------------------------------------------"
            echo "ðŸ“Œ Comparing: ZIP vs APIM"
            echo "-------------------------------------------------------"
          
            # Compare roles
            for ROLE in $ZIP_ROLES; do
              if ! echo "$APIM_ROLES" | grep -qw "$ROLE"; then
                echo "âš ï¸ Missing Role in APIM: $ROLE"
              else
                echo "âœ” Role exists: $ROLE"
              fi
            done
            echo
          
            # Compare policies
            for P in $ZIP_POLICIES; do
              if ! echo "$APIM_POLICIES" | grep -qw "$P"; then
                echo "âš ï¸ Missing Policy in APIM: $P"
              else
                echo "âœ” Policy exists: $P"
              fi
            done
            echo
          
            # Compare labels
            for L in $ZIP_LABELS; do
              if ! echo "$APIM_LABELS" | grep -qw "$L"; then
                echo "âš ï¸ Missing Gateway Label in APIM: $L"
              else
                echo "âœ” Gateway Label exists: $L"
              fi
            done
            echo
          
            # Compare categories
            for C in $ZIP_CATEGORIES; do
              if ! echo "$APIM_CATEGORIES" | grep -qw "$C"; then
                echo "âš ï¸ Missing API Category in APIM: $C"
              else
                echo "âœ” API Category exists: $C"
              fi
            done
            echo
          
            # Check Endpoint Certificates
            for E in $ZIP_ENDPOINTS; do
              HOST=$(echo "$E" | sed -E 's@https?://([^:/]+).*@\1@')
              if keytool -printcert -rfc -sslserver "$HOST" >/dev/null 2>&1; then
                echo "âœ” Endpoint cert valid: $HOST"
              else
                echo "âš ï¸ Endpoint cert NOT trusted: $HOST"
              fi
            done
          
          done
          
          echo "VALIDATION_ERRORS=$VALIDATION_ERRORS" >> $GITHUB_OUTPUT


======================================


# Find inner folder (example: ***-1.0.0)
INNER_DIR=$(find "extracted/$api" -maxdepth 1 -type d ! -path "extracted/$api")

API_YAML="$INNER_DIR/api.yaml"

if [[ ! -f "$API_YAML" ]]; then
  echo "âŒ api.yaml missing inside zip: $api"
  echo "Checked path: $API_YAML"
  VALIDATION_ERRORS=$((VALIDATION_ERRORS+1))
  continue
fi


=====================================================================


- name: Install yq
  working-directory: ${{ env.WORKSPACE }}
  run: |
    WORK_DIR="$RUNNER_WORKSPACE/yq"
    mkdir -p "$WORK_DIR"

    if [ ! -f "$WORK_DIR/yq" ]; then
      cd "$WORK_DIR"
      echo "Downloading yq to $WORK_DIR..."
      wget "https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64" -O yq
    fi

    chmod +x "$WORK_DIR/yq"
    echo "$WORK_DIR" >> $GITHUB_PATH
    echo "yq path added to PATH: $WORK_DIR"
